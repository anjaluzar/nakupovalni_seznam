name: CI-CD Pipeline

on:
  push:
    branches: [ main, production ]
  pull_request:
    branches: [ main, production ]

env:
  NODE_VERSION: "20"
  CLIENT_IMAGE: nakupovalni-client
  SERVER_IMAGE: nakupovalni-server

jobs:
  build:
    name: Build + Cache + Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ---------- CACHE ----------
      - name: Cache client node_modules
        uses: actions/cache@v4
        with:
          path: client/node_modules
          key: ${{ runner.os }}-client-${{ hashFiles('client/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-client-

      - name: Cache server node_modules
        uses: actions/cache@v4
        with:
          path: server/node_modules
          key: ${{ runner.os }}-server-${{ hashFiles('server/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-server-

      # ---------- BUILD CLIENT ----------
      - name: Install client deps
        working-directory: client
        run: npm ci

      - name: Build client
        working-directory: client
        run: npm run build

      - name: Upload client artifact
        uses: actions/upload-artifact@v4
        with:
          name: client_build
          path: client/build

      # ---------- BUILD / TEST SERVER ----------
      - name: Install server deps
        working-directory: server
        run: npm ci

      - name: Test server
        working-directory: server
        run: npm test

      - name: Pack server artifact
        run: tar -czf server-artifact.tar.gz -C server .

      - name: Upload server artifact
        uses: actions/upload-artifact@v4
        with:
          name: server_artifact
          path: server-artifact.tar.gz

  # ---------------- SONARCLOUD ANALYSIS ----------------
  sonarcloud:
    name: SonarCloud Analyze (client + server)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout (full history for Sonar)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # cache - pospeši ponovne rune
      - name: Cache client node_modules
        uses: actions/cache@v4
        with:
          path: client/node_modules
          key: ${{ runner.os }}-client-${{ hashFiles('client/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-client-

      - name: Cache server node_modules
        uses: actions/cache@v4
        with:
          path: server/node_modules
          key: ${{ runner.os }}-server-${{ hashFiles('server/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-server-

      # ---- TESTS + COVERAGE (client) ----
      - name: Install client deps
        working-directory: client
        run: npm ci

      - name: Test client (with coverage)
        working-directory: client
        run: npm test -- --coverage --watchAll=false

      # ---- TESTS + COVERAGE (server) ----
      - name: Install server deps
        working-directory: server
        run: npm ci

      - name: Test server (with coverage)
        working-directory: server
        run: npm test -- --coverage

      # (Opcijsko) Debug, če želiš videti, da LCOV obstaja tudi na CI
      - name: Debug coverage files
        run: |
          echo "CLIENT COVERAGE:"
          ls -la client/coverage || true
          echo "SERVER COVERAGE:"
          ls -la server/coverage || true

      # ---- SONARCLOUD SCAN ----
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.projectBaseDir=.
            -Dsonar.sources=client/src,server
            -Dsonar.tests=client/src,server
            -Dsonar.test.inclusions=**/*.test.*,**/*.spec.*
            -Dsonar.exclusions=**/node_modules/**,**/build/**,**/dist/**,**/coverage/**,**/*.min.js
            -Dsonar.javascript.lcov.reportPaths=client/coverage/lcov.info,server/coverage/lcov.info
            -Dsonar.sourceEncoding=UTF-8

  # ---------------- QUALITY GATE CHECK (API) ----------------
  quality_gate:
    name: SonarCloud Quality Gate (API check)
    runs-on: ubuntu-latest
    needs: sonarcloud

    steps:
      - name: Check Quality Gate via SonarCloud API
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        run: |
          set -euo pipefail

          RESP="$(curl -sS -u "${SONAR_TOKEN}:" \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=${SONAR_PROJECT_KEY}")"

          echo "Response: $RESP"
          STATUS="$(echo "$RESP" | python -c "import sys, json; print(json.load(sys.stdin)['projectStatus']['status'])")"
          echo "Quality Gate status: $STATUS"

          if [ "$STATUS" != "OK" ]; then
            echo "Quality Gate ni OK -> prekinjam pipeline."
            exit 1
          fi

          echo "Quality Gate OK."

  docker:
    name: Docker Build + Push (Docker Hub)
    runs-on: ubuntu-latest
    needs: [build, sonarcloud]
    outputs:
      client_image: ${{ steps.meta.outputs.client_image }}
      server_image: ${{ steps.meta.outputs.server_image }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download client artifact
        uses: actions/download-artifact@v4
        with:
          name: client_build
          path: client/build

      - name: Download server artifact
        uses: actions/download-artifact@v4
        with:
          name: server_artifact
          path: server_artifact

      - name: Unpack server artifact
        run: |
          mkdir -p server-deploy
          tar -xzf server_artifact/server-artifact.tar.gz -C server-deploy

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set image tags (dev/prod)
        id: meta
        run: |
          if [ "${GITHUB_REF_NAME}" = "production" ]; then
            TAG="prod"
          else
            TAG="dev"
          fi

          echo "client_image=${{ secrets.DOCKER_USERNAME }}/${{ env.CLIENT_IMAGE }}:$TAG" >> $GITHUB_OUTPUT
          echo "server_image=${{ secrets.DOCKER_USERNAME }}/${{ env.SERVER_IMAGE }}:$TAG" >> $GITHUB_OUTPUT

          echo "CLIENT_IMAGE=${{ secrets.DOCKER_USERNAME }}/${{ env.CLIENT_IMAGE }}:$TAG" >> $GITHUB_ENV
          echo "SERVER_IMAGE=${{ secrets.DOCKER_USERNAME }}/${{ env.SERVER_IMAGE }}:$TAG" >> $GITHUB_ENV

      - name: Build & Push client image
        run: |
          docker build -t "$CLIENT_IMAGE" -f client/Dockerfile client
          docker push "$CLIENT_IMAGE"

      - name: Build & Push server image
        run: |
          docker build -t "$SERVER_IMAGE" -f server/Dockerfile server-deploy
          docker push "$SERVER_IMAGE"

  deploy_dev:
    name: Deploy Development (Render)
    runs-on: ubuntu-latest
    needs: docker
    if: github.ref_name == 'main'
    environment: Development

    steps:
      - name: Trigger Render Deploy Hook (DEV)
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
          CLIENT_IMAGE: ${{ needs.docker.outputs.client_image }}
          SERVER_IMAGE: ${{ needs.docker.outputs.server_image }}
        run: |
          echo "DEV deploy"
          echo "Client image: $CLIENT_IMAGE"
          echo "Server image: $SERVER_IMAGE"

          if [ -z "$RENDER_DEPLOY_HOOK_URL" ]; then
            echo "RENDER_DEPLOY_HOOK_URL ni nastavljen. Preskakujem deploy."
            exit 0
          fi

          curl -fsS -X POST "$RENDER_DEPLOY_HOOK_URL"
          echo "OK"

  deploy_prod:
    name: Deploy Production (Render)
    runs-on: ubuntu-latest
    needs: [docker, quality_gate]
    if: github.ref_name == 'production'
    environment: Production

    steps:
      - name: Trigger Render Deploy Hook (PROD)
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
          CLIENT_IMAGE: ${{ needs.docker.outputs.client_image }}
          SERVER_IMAGE: ${{ needs.docker.outputs.server_image }}
        run: |
          echo "PROD deploy"
          echo "Client image: $CLIENT_IMAGE"
          echo "Server image: $SERVER_IMAGE"

          if [ -z "$RENDER_DEPLOY_HOOK_URL" ]; then
            echo "RENDER_DEPLOY_HOOK_URL ni nastavljen. Preskakujem deploy."
            exit 0
          fi

          curl -fsS -X POST "$RENDER_DEPLOY_HOOK_URL"
          echo "OK"

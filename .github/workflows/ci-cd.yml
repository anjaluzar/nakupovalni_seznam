name: CI-CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: "20"
  CLIENT_IMAGE: nakupovalni-client
  SERVER_IMAGE: nakupovalni-server

jobs:
  build:
    name: Build + Cache + Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ---------- CACHE ----------
      - name: Cache client node_modules
        uses: actions/cache@v4
        with:
          path: client/node_modules
          key: ${{ runner.os }}-client-${{ hashFiles('client/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-client-

      - name: Cache server node_modules
        uses: actions/cache@v4
        with:
          path: server/node_modules
          key: ${{ runner.os }}-server-${{ hashFiles('server/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-server-

      # ---------- BUILD CLIENT ----------
      - name: Install client deps
        working-directory: client
        run: npm ci

      - name: Build client
        working-directory: client
        run: npm run build

      # ⚠️ Če imaš Vite, je output "dist" (ne build).
      # Zamenjaj client/build -> client/dist (tukaj in spodaj v docker jobu).
      - name: Upload client artifact
        uses: actions/upload-artifact@v4
        with:
          name: client_build
          path: client/build

      # ---------- BUILD / TEST SERVER ----------
      - name: Install server deps
        working-directory: server
        run: npm ci

      - name: Test server
        working-directory: server
        run: npm test

      # Naredimo tar celotnega serverja, da ga lahko uporabimo kot docker context v naslednjem jobu
      - name: Pack server artifact
        run: tar -czf server-artifact.tar.gz -C server .

      - name: Upload server artifact
        uses: actions/upload-artifact@v4
        with:
          name: server_artifact
          path: server-artifact.tar.gz

  docker:
    name: Docker Build + Push (Docker Hub)
    runs-on: ubuntu-latest
    needs: build

    outputs:
      client_image: ${{ steps.meta.outputs.client_image }}
      server_image: ${{ steps.meta.outputs.server_image }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download client artifact
        uses: actions/download-artifact@v4
        with:
          name: client_build
          path: client/build   # če imaš Vite -> client/dist

      - name: Download server artifact
        uses: actions/download-artifact@v4
        with:
          name: server_artifact
          path: server_artifact

      - name: Unpack server artifact
        run: |
          mkdir -p server-deploy
          ls -la server_artifact
          tar -xzf server_artifact/server-artifact.tar.gz -C server-deploy
          ls -la server-deploy

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set image tags
        id: meta
        run: |
          echo "client_image=${{ secrets.DOCKER_USERNAME }}/${{ env.CLIENT_IMAGE }}:${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "server_image=${{ secrets.DOCKER_USERNAME }}/${{ env.SERVER_IMAGE }}:${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "CLIENT_IMAGE=${{ secrets.DOCKER_USERNAME }}/${{ env.CLIENT_IMAGE }}:${{ github.sha }}" >> $GITHUB_ENV
          echo "SERVER_IMAGE=${{ secrets.DOCKER_USERNAME }}/${{ env.SERVER_IMAGE }}:${{ github.sha }}" >> $GITHUB_ENV

      - name: Build & Push client image
        run: |
          docker build -t "$CLIENT_IMAGE" -f client/Dockerfile client
          docker push "$CLIENT_IMAGE"

      - name: Build & Push server image
        run: |
          docker build -t "$SERVER_IMAGE" -f server/Dockerfile server-deploy
          docker push "$SERVER_IMAGE"

  deploy:
    name: Deploy (Render)
    runs-on: ubuntu-latest
    needs: docker

    steps:
      - name: Trigger Render Deploy Hook
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
          CLIENT_IMAGE: ${{ needs.docker.outputs.client_image }}
          SERVER_IMAGE: ${{ needs.docker.outputs.server_image }}
        run: |
          if [ -z "$RENDER_DEPLOY_HOOK_URL" ]; then
            echo "RENDER_DEPLOY_HOOK_URL ni nastavljen (GitHub Secret). Preskakujem deploy."
            echo "Client image: $CLIENT_IMAGE"
            echo "Server image: $SERVER_IMAGE"
            exit 0
          fi

          echo "Sprožam Render deploy hook..."
          curl -fsS -X POST "$RENDER_DEPLOY_HOOK_URL"
          echo "OK"
